### SQL PLANNING CONCEPT ###
This section covers the concept of how SQL queries are planned and executed by Wren engine. It's useful to understand this concept when generating or correcting SQL queries for Wren engine.
Wren engine planned the SQL according to a Model definition Language (MDL) which defines the structure of the tables used in the SQL queries.
When a SQL query is submitted to the Wren engine, it undergoes several stages of processing before the final result is returned. The key stages include:
    1. Parsing: The SQL query is parsed into an abstract syntax tree (AST) representation.
    2. Planning: The SQL query will be constructed by the Wren engine into an intermediate representation (IR). Wren engine will analyze the used tables and columns to generate the subquery for each table according to the definition of the model. All the tables used in the SQL are models of Wren engine. The model defines how the table is structured, including the columns, data types, and relationships with other tables. 
    3. Unparsing: This IR is then unparsed into a SQL in a generic dialect.
    4. Transpile: The generic SQL is then transpiled into the specific SQL dialect of the target database.
    5. Execution: The transpiled SQL is then executed against the target database, and the results are fetched.

### SQL CORRECTION CONCEPT ###
This section covers the concept how to correction the SQL queries generated by Wren engine. 

The SQL in different stages may look different due to the transformations applied during planning and transpiling:
- Wren SQL: The SQL written by user and submitted to Wren engine.
- Planned SQL: The SQL generated after planning and unparsing stages from the Wren engine.
- Dialect SQL: The SQL generated after transpiling stage from the Wren engine, which is specific to the target database dialect.

The error messages will contain information about which stage the error occurred in and the planned or dialect SQL that caused the error.
This is important to identify where the issue lies and how to correct it.
Example error messages:
```
{
  "errorCode": "GENERIC_USER_ERROR",
  "message": "400 TIMESTAMP +/- INTERVAL is not supported for intervals with non-zero MONTH or YEAR part.; reason: invalidQuery, location: query, message: TIMESTAMP +/- INTERVAL is not supported for intervals with non-zero MONTH or YEAR part.\n\nLocation: US\nJob ID: 906455a6-7178-2139-8a37-d30551097438\n",
  "metadata": {
    "dialectSql": "SELECT CURRENT_TIMESTAMP() - INTERVAL '1' MONTH"
  },
  "phase": "SQL_EXECUTION",
  "timestamp": "2025-12-16T15:54:55.166328",
  "correlationId": "21a3fb0e-1765-42d1-b395-85c606817b15"
}
```

If the generated SQL query can't be executed successfully against the target database, you should think about the following steps to correct the Wren SQL directly:
    1. Identify the error:
        1. Check where the error message comes from. It could be from the Wren engine during planning, transpiling, or from the target database during execution. You can check the phase of the error from the error message or logs.
        2. If the error is from the parsing stage, it means the Wren SQL has syntax issues. You needs to check the SQL syntax and correct it.
        3. If the error is from the planning staging, it could be due to unsupported SQL constructs or issues with the model definitions. You need to review the Wren SQL and the MDL definitions to ensure they are correct.
           If a not-found table or columns error occurs in the planning stage, check if the used tables and columns are exactly defined in the MDL.
        4. If the error is from the transpiling staging, it could be an internal bug of Wren engine. You may need to report the issue to the Wren support team for further investigation.
        5. If the error is from the execution stage, You need to check the Dialect SQL generated by Wren engine and the target database documentation to identify any compatibility issues or unsupported features. If the issue is identified, you can modify the Wren SQL to avoid using those unsupported features.
           If a not-found table or columns error occurs in the execution stage, check the location of the error. If it occurs in the source subquery (typically, called `__source` or the deepest subquery) of a table, it means the model definition is not synchronized with the target database schema. You need to report it to the user as an USER ERROR, not a BUG of Wren engine.
           If it occurs in the main query or a joined subquery, it means there are some internal issues of Wren engine during planning or transpiling. You may need to report the issue as an INTERNAL ERROR to the Wren support team for further investigation.
        6. If an error occurs during execution but not during dry-run, it could be due to data-related issues or runtime constraints. You need to analyze the execution context and data to identify and resolve these issues.
        7. It could be a data quality issue, such as unexpected NULL values, unexpected string values, or data type mismatches. You may need to check the sample data in the target database to identify any anomalies.
        8. If a timeout or resource limit error occurs during execution, it could be due to the complexity of the query or the size of the data being processed. You may need to optimize the Wren SQL to reduce its complexity or limit the amount of data being processed.
    2. Modify the Wren SQL:
        1. Based on the identified error, modify the Wren SQL to correct the issues. This may involve changing the SQL syntax, adjusting the query structure, or using different SQL constructs that are supported by Wren engine and the target database.
        2. You can only modify the Wren SQL directly. You are not allowed to modify the Planned SQL or Dialect SQL generated by Wren engine. So, you need to think about how to change the Wren SQL to achieve the desired Planned SQL or Dialect SQL.
    3. Test the corrected SQL:
        1. Resubmit the modified Wren SQL to Wren engine and check if it executes successfully against the target database. If further errors occur, repeat the identification and modification steps until the SQL executes successfully.
    4. Validate the results:
        1. Once the SQL executes successfully, validate the results to ensure they meet the expected outcomes. If the results are not as expected, you may need to further refine the Wren SQL to achieve the desired results.
        2. The SQL should be validated through dry-run first, then through actual execution.
    5. Report bugs:
        1. Try to avoid reporting bugs of Wren engine unless absolutely necessary. First, try to find an alternative way to write the Wren SQL to achieve the same result without triggering the bug or unsupported features.
        2. If no alternative and the generated SQL is reasonable and should be supported, but still fails due to internal issues of Wren engine, report the issue to the Wren support team for further investigation and resolution.
        3. If no alternative and a timeout or resource limit error occurs, report the issue to the user as an EXTERNAL ERROR, not a BUG of Wren engine. You may suggest the user to check their database performance or simplify their question.
        4. If no alternative and the error code is `GENERIC_INTERNAL_ERROR` or `SQLGLOT_ERROR` (it means transpiling error), report the issue to the Wren support team for further investigation and resolution.
